<div class="dashboard-container" *ngIf="expediente">
  <header class="d-flex justify-content-between align-items-center">
    <div class="logo-text d-flex align-items-center">
      <h5 class="m-0 text-warning fw-bold">Esperanza Viva</h5>
      <small class="text-white ms-2" style="font-size: 0.8rem; margin-top: 4px;">centro de conciliacion</small>
    </div>
    <button class="btn-volver" routerLink="/consulta">
      <i class="bi bi-arrow-left"></i> volver al inicio
    </button>
  </header>

  <div class="container mt-4">
    <div class="row">
      <!-- Left Column -->
      <div class="col-lg-8 mb-4">
        <!-- Main Details Card -->
        <div class="custom-card p-4 mb-4">
          <h4 class="card-title text-warning">Expediente {{ expediente.numeroExpediente }}</h4>
          <p class="section-value text-muted">Fecha de presentación: {{ expediente.fechaCreacion | date:'dd/MM/yyyy' }}
          </p>

          <div class="row mt-4">
            <div class="col-md-6 mb-3">
              <span class="section-label">Solicitante</span>
              <div class="section-value">{{ expediente.solicitante?.nombres }} {{ expediente.solicitante?.apellidos }}
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <span class="section-label">Invitado</span>
              <div class="section-value">{{ expediente.invitado?.nombres }} {{ expediente.invitado?.apellidos }}</div>
            </div>
            <!-- Line Separator logic visually handled by row spacing -->

            <div class="col-md-6 mb-3 border-top border-secondary pt-3">
              <span class="section-label">Materia</span>
              <div class="section-value">{{ expediente.materiaConciliable }}</div>
            </div>
            <div class="col-md-6 mb-3 border-top border-secondary pt-3">
              <span class="section-label">Modalidad</span>
              <div class="section-value">{{ expediente.modalidad || 'Presencial' }}</div>
            </div>

            <div class="col-md-6 mb-3">
              <span class="section-label d-block mb-1">Conciliador Asignado</span>
              <div class="section-value animate__animated animate__fadeIn"
                [class.text-warning]="!expediente.conciliador" [class.text-success]="expediente.conciliador">

                <!-- Display Conciliator Info if exists -->
                <div *ngIf="expediente.conciliador || expediente.nombreConciliador; else sinConciliador">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-person-check-fill me-2 fs-4 text-success"></i>
                    <strong class="fs-5 text-white">
                      <!-- 1. Full Object with nombres/apellidos -->
                      <span *ngIf="expediente.conciliador?.nombres">
                        {{ expediente.conciliador.nombres }} {{ expediente.conciliador.apellidos }}
                      </span>
                      <span *ngIf="!expediente.conciliador?.nombres && expediente.conciliador?.nombreCompleto">
                        {{ expediente.conciliador.nombreCompleto }}
                      </span>
                      <span
                        *ngIf="!expediente.conciliador?.nombres && !expediente.conciliador?.nombreCompleto && expediente.conciliador?.nombre_completo">
                        {{ expediente.conciliador.nombre_completo }}
                      </span>
                      <span
                        *ngIf="!expediente.conciliador?.nombres && !expediente.conciliador?.nombreCompleto && !expediente.conciliador?.nombre_completo && expediente.conciliador?.nombre">
                        {{ expediente.conciliador.nombre }}
                      </span>
                      <!-- 5. Fallback: String name on expediente -->
                      <span
                        *ngIf="!expediente.conciliador?.nombres && !expediente.conciliador?.nombreCompleto && !expediente.conciliador?.nombre_completo && !expediente.conciliador?.nombre && expediente.nombreConciliador">
                        {{ expediente.nombreConciliador }}
                      </span>
                      <!-- 6. Ultimate Fallback: ID or generic msg -->
                      <span
                        *ngIf="!expediente.conciliador?.nombres && !expediente.conciliador?.nombreCompleto && !expediente.conciliador?.nombre_completo && !expediente.conciliador?.nombre && !expediente.nombreConciliador">
                        Conciliador Asignado (ID: {{ expediente.conciliador?.id || expediente.conciliador }})
                      </span>
                    </strong>
                  </div>

                  <!-- Registration Number -->
                  <div *ngIf="expediente.conciliador?.nroRegistro || expediente.conciliador?.nro_registro"
                    class="small text-muted ms-5 mt-1">
                    Reg. N° {{ expediente.conciliador?.nroRegistro || expediente.conciliador?.nro_registro }}
                  </div>
                </div>

                <ng-template #sinConciliador>
                  <div class="d-flex align-items-center mt-1">
                    <i class="bi bi-hourglass-split me-2 fs-5 text-warning"></i>
                    <span class="fs-5">Pendiente de Asignación</span>
                  </div>
                </ng-template>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <span class="section-label">Próxima Audiencia</span>
              <div class="section-value">
                <div *ngIf="expediente.fechaAudiencia || expediente.audiencia?.fecha; else porProgramar">
                  <i class="bi bi-calendar-check text-warning me-2"></i>
                  {{ (expediente.fechaAudiencia || expediente.audiencia?.fecha) | date:'dd/MM/yyyy' }}
                  <span class="ms-2 badge bg-dark text-warning border border-warning">
                    {{ expediente.horaAudiencia || expediente.audiencia?.hora }}
                  </span>
                </div>
                <ng-template #porProgramar>
                  <span class="text-muted fst-italic">Por programar</span>
                </ng-template>
              </div>
            </div>
          </div>
        </div>

        <!-- Status Timeline Card -->
        <div class="custom-card p-4">
          <h5 class="card-title text-warning mb-4">Estado el Proceso</h5>
          <p class="text-muted small mb-4">Seguimiento del proceso de conciliación</p>

          <div class="timeline">
            <!-- 1. En Revision -->
            <div class="timeline-item active">
              <div class="timeline-icon text-green"><i class="bi bi-file-earmark-text"></i></div>
              <h6 class="text-green fw-bold">En Revision</h6>
              <small class="text-muted">Solicitud recibida<br>{{ expediente.fechaCreacion | date:'dd/MM/yyyy' }}</small>
            </div>

            <!-- 2. Aprobada -->
            <div class="timeline-item"
              [ngClass]="{'active': isStateAfterOrEqual('APROBADA'), 'current': expediente.estado === 'APROBADA'}">
              <div class="timeline-icon" [ngClass]="isStateAfterOrEqual('APROBADA') ? 'text-green' : 'text-muted'"><i
                  class="bi bi-check-circle"></i></div>
              <h6 [class.text-green]="isStateAfterOrEqual('APROBADA')"
                [class.text-white]="!isStateAfterOrEqual('APROBADA')">Aprobada</h6>
              <small class="text-muted">Solicitud validada por el director</small>
            </div>

            <!-- 3. En Audiencia -->
            <div class="timeline-item"
              [ngClass]="{'active': isStateAfterOrEqual('AUDIENCIA_PROGRAMADA'), 'current': expediente.estado === 'AUDIENCIA_PROGRAMADA'}">
              <div class="timeline-icon"
                [ngClass]="isStateAfterOrEqual('AUDIENCIA_PROGRAMADA') ? 'text-green' : 'text-muted'"><i
                  class="bi bi-clock"></i></div>
              <h6 [class.text-green]="isStateAfterOrEqual('AUDIENCIA_PROGRAMADA')"
                [class.text-white]="!isStateAfterOrEqual('AUDIENCIA_PROGRAMADA')">En Audiencia</h6>
              <small class="text-muted">Proceso de conciliación en curso</small>
            </div>

            <!-- 4. Finalizada -->
            <div class="timeline-item"
              [ngClass]="{'active': isStateAfterOrEqual('FINALIZADA'), 'current': expediente.estado === 'FINALIZADA'}">
              <div class="timeline-icon" [ngClass]="isStateAfterOrEqual('FINALIZADA') ? 'text-green' : 'text-muted'"><i
                  class="bi bi-flag"></i></div>
              <h6 [class.text-green]="isStateAfterOrEqual('FINALIZADA')"
                [class.text-white]="!isStateAfterOrEqual('FINALIZADA')">Finalizada</h6>
              <small class="text-muted">Proceso concluido</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div class="col-lg-4">
        <!-- Notifications -->
        <div class="custom-card p-4 mb-4">
          <h5 class="card-title text-warning">Notificaciones</h5>
          <p class="text-muted small mb-3">Comunicaciones del centro de conciliación</p>

          <div class="notif-card" *ngIf="expediente.fechaAudiencia || expediente.audiencia?.fecha">
            <div class="notif-title text-warning">Audiencia Programada</div>
            <div class="notif-body">
              Se ha programado la audiencia de conciliación para el {{ (expediente.fechaAudiencia ||
              expediente.audiencia?.fecha) | date:'dd/MM/yyyy' }}
              a las {{ expediente.horaAudiencia || expediente.audiencia?.hora }}.
            </div>
            <span class="notif-date">{{ expediente.fechaCreacion | date:'dd/MM/yyyy' }}</span>
          </div>

          <div class="notif-card" *ngIf="isStateAfterOrEqual('APROBADA')">
            <div class="notif-title text-warning">Solicitud Aprobada</div>
            <div class="notif-body">
              Su solicitud ha sido aprobada por el Director del Centro de Conciliación.
            </div>
          </div>

          <div class="notif-card">
            <div class="notif-title text-warning">Observación del Director</div>
            <div class="notif-body">
              {{ expediente.observacion || 'Por favor, asegúrese de presentarse 15 minutos antes de la hora programada
              con su documento de identidad.' }}
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="custom-card p-4">
          <h5 class="card-title text-warning mb-3">Acciones</h5>
          <button class="btn-action-primary" (click)="actualizarEstadoButton()">
            Actualizar Estado
          </button>
          <button class="btn-action-primary">Descargar solicitud</button>
          <button class="btn-action-danger">Desistir de la solicitud</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="text-center mt-5" *ngIf="cargando">
  <div class="spinner-border text-warning" role="status"></div>
  <p class="text-warning mt-3">Cargando expediente...</p>
</div>

<div class="container text-center mt-5" *ngIf="!cargando && !expediente">
  <div class="custom-card p-5 border-danger mx-auto" style="max-width: 600px;">
    <h3 class="text-danger mb-3">Expediente No Encontrado</h3>
    <p class="text-white mb-4">No se encontró el expediente consultado.</p>
    <button class="btn btn-warning fw-bold" routerLink="/consulta">Volver a intentar</button>
  </div>
</div>
