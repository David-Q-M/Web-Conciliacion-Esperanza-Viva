<div class="admin-container">
  <aside class="sidebar-viva">
    <div class="logo-section">
      <h5 class="m-0 fw-bold text-dark">ESPERANZA VIVA</h5>
      <small class="text-dark fw-bold">ADMINISTRACIÓN</small>
    </div>
    <nav class="sidebar-nav">
      <a class="nav-link-viva" routerLink="/admin-dashboard" routerLinkActive="active">
        <i class="bi bi-speedometer2 me-2"></i> Inicio
      </a>
      <a class="nav-link-viva active" routerLink="/gestion-usuarios" routerLinkActive="active">
        <i class="bi bi-people-fill me-2"></i> Gestión de usuarios
      </a>
      <a class="nav-link-viva" routerLink="/configuracion" routerLinkActive="active">
        <i class="bi bi-sliders me-2"></i> Configuración
      </a>
      <a class="nav-link-viva" routerLink="/auditoria" routerLinkActive="active">
        <i class="bi bi-shield-lock-fill me-2"></i> Auditoría
      </a>
      <a class="nav-link-viva" routerLink="/reportes" routerLinkActive="active">
        <i class="bi bi-bar-chart-fill me-2"></i> Reportes
      </a>
    </nav>
    <div class="sidebar-footer px-3">
      <button class="btn w-100 fw-bold" style="background: #000; color: #fff;" (click)="cerrarSesion()">
        <i class="bi bi-box-arrow-left"></i> Cerrar Sesión
      </button>
    </div>
  </aside>

  <main class="main-content-viva">
    <!-- Header -->
    <header class="d-flex justify-content-between align-items-center mb-5">
      <div class="header-titles">
        <h2 class="text-warning fw-bold m-0">Gestión de Usuarios</h2>
        <p class="text-secondary small m-0">Panel administrativo de control total</p>
      </div>
      <div class="admin-badge text-end">
        <div class="text-white fw-bold">{{ usuarioActivo }}</div>
        <small class="text-success">● En línea</small>
      </div>
    </header>

    <!-- Toolbar -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div class="text-white">
        <h4 class="m-0 fw-bold">Personal Registrado</h4>
        <small class="text-secondary">{{ usuarios.length }} usuarios activos en el sistema</small>
      </div>
      <button class="btn-register-viva" (click)="abrirRegistro()">
        <i class="bi bi-person-plus-fill me-2"></i> Registrar Empleado
      </button>
    </div>

    <!-- Table Card -->
    <div class="glass-card p-0 overflow-hidden">
      <div class="table-responsive">
        <table class="table table-dark table-hover m-0 align-middle">
          <thead>
            <tr class="text-secondary small text-uppercase">
              <th class="ps-4">Usuario</th>
              <th>Rol</th>
              <th>Credenciales</th>
              <th>Contacto</th>
              <th>Estado</th>
              <th class="text-end pe-4">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let u of usuarios">
              <td class="ps-4">
                <div class="fw-bold text-white">{{ u.nombreCompleto }}</div>
                <div class="small text-secondary">{{ u.usuario }}</div>
              </td>
              <td>
                <div class="d-flex flex-wrap gap-1">
                  <span *ngFor="let r of u.roles" class="role-pill" [ngClass]="r.toLowerCase()">{{ r }}</span>
                </div>
              </td>
              <td>
                <small class="text-secondary" *ngIf="u.roles?.includes('CONCILIADOR')">Reg: {{ u.nroRegistro }}</small>
                <small class="text-secondary" *ngIf="u.roles?.includes('ABOGADO')">Col: {{ u.nroColegiatura }}</small>
                <small class="text-secondary"
                  *ngIf="!u.roles?.includes('CONCILIADOR') && !u.roles?.includes('ABOGADO')">--</small>
              </td>
              <td>
                <div class="text-white small"><i class="bi bi-envelope me-2 text-secondary"></i>{{ u.correoElectronico
                  }}</div>
                <div class="text-secondary small"><i class="bi bi-telephone me-2"></i>{{ u.telefono }}</div>
              </td>
              <td>
                <span class="badge" [ngClass]="u.estado === 'ACTIVO' ? 'bg-success' : 'bg-danger'">{{ u.estado }}</span>
              </td>
              <td class="text-end pe-4">
                <button class="btn btn-sm btn-outline-warning border-0 me-1" (click)="abrirEdicion(u)" title="Editar">
                  <i class="bi bi-pencil-square fs-5"></i>
                </button>
                <button class="btn btn-sm border-0 me-1"
                  [ngClass]="u.estado === 'ACTIVO' ? 'btn-outline-warning' : 'btn-outline-success'"
                  (click)="toggleBloqueo(u)" [title]="u.estado === 'ACTIVO' ? 'Suspender Acceso' : 'Reactivar Acceso'">
                  <i class="bi fs-5" [ngClass]="u.estado === 'ACTIVO' ? 'bi-lock-fill' : 'bi-unlock-fill'"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger border-0" (click)="eliminarUsuario(u.id, u.nombreCompleto)"
                  title="Eliminar">
                  <i class="bi bi-trash3-fill fs-5"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- Modal de Registro/Edición -->
  <div class="viva-modal-overlay animate__animated animate__fadeIn" *ngIf="mostrarModal">
    <div class="viva-modal-card animate__animated animate__zoomIn">

      <!-- Header Fijo -->
      <div class="modal-header-viva">
        <h5 class="text-warning m-0 fw-bold">{{ modoEdicion ? 'Actualizar Datos' : 'Nuevo Registro' }}</h5>
        <button class="close-viva" (click)="mostrarModal = false"><i class="bi bi-x-lg"></i></button>
      </div>

      <!-- Cuerpo Scrolleable -->
      <div class="modal-body-scroll">
        <div class="row g-3">
          <div class="col-12">
            <label class="label-viva">NOMBRE COMPLETO</label>
            <input type="text" [(ngModel)]="usuarioForm.nombreCompleto" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="label-viva">DNI</label>
            <input type="text" [(ngModel)]="usuarioForm.dni" maxlength="8" class="form-control">
          </div>
          <div class="col-md-6">
            <label class="label-viva">CELULAR</label>
            <input type="text" [(ngModel)]="usuarioForm.telefono" maxlength="9" class="form-control">
          </div>
          <div class="col-12">
            <label class="label-viva">DIRECCIÓN</label>
            <input type="text" [(ngModel)]="usuarioForm.direccion" class="form-control">
          </div>
          <div class="col-12">
            <label class="label-viva">CORREO ELECTRÓNICO</label>
            <input type="email" [(ngModel)]="usuarioForm.correoElectronico" class="form-control">
          </div>

          <div class="col-md-6 pt-3">
            <label class="label-viva text-warning">USUARIO DE ACCESO</label>
            <input type="text" [(ngModel)]="usuarioForm.usuario" class="form-control border-warning">
          </div>
          <div class="col-md-6 pt-3">
            <label class="label-viva text-warning">CONTRASEÑA</label>
            <input type="password" [(ngModel)]="usuarioForm.contrasena" class="form-control border-warning"
              placeholder="******">
          </div>

          <div class="col-12 mt-3">
            <label class="label-viva mb-2">ROLES DE SISTEMA</label>
            <div class="d-flex flex-wrap gap-3 bg-dark p-3 rounded border border-secondary">
              <div *ngFor="let r of listaRoles" class="form-check">
                <input class="form-check-input bg-dark border-secondary" type="checkbox"
                  [checked]="usuarioForm.roles?.includes(r)" (change)="toggleRol(r)">
                <label class="form-check-label text-white small ms-1">{{ r }}</label>
              </div>
            </div>
          </div>

          <div class="col-md-6 mt-2">
            <label class="label-viva">ESTADO</label>
            <select [(ngModel)]="usuarioForm.estado" class="form-select">
              <option value="ACTIVO">ACTIVO</option>
              <option value="INACTIVO">INACTIVO</option>
            </select>
          </div>

          <!-- Campos Dinámicos -->
          <div class="col-12 mt-3"
            *ngIf="usuarioForm.roles?.includes('CONCILIADOR') || usuarioForm.roles?.includes('ABOGADO')">
            <div class="p-3 border border-info border-dashed rounded bg-dark">
              <div *ngIf="usuarioForm.roles?.includes('CONCILIADOR')" class="mb-2">
                <label class="label-viva text-info">Nº REGISTRO MINJUS</label>
                <input type="text" [(ngModel)]="usuarioForm.nroRegistro" class="form-control mb-2">
                <label class="label-viva text-info">Nº ESPECIALIZACIÓN</label>
                <input type="text" [(ngModel)]="usuarioForm.nroEspecializacion" class="form-control">
              </div>
              <div *ngIf="usuarioForm.roles?.includes('ABOGADO')">
                <label class="label-viva text-info">Nº COLEGIATURA</label>
                <input type="text" [(ngModel)]="usuarioForm.nroColegiatura" class="form-control">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer Fijo -->
      <div class="modal-footer-viva">
        <button class="btn btn-outline-secondary" (click)="mostrarModal = false">Cancelar</button>
        <button class="btn btn-warning fw-bold px-4" (click)="guardar()" [disabled]="!esFormularioValido()">
          {{ modoEdicion ? 'Actualizar Datos' : 'Crear Usuario' }}
        </button>
      </div>
    </div>
  </div>
</div>